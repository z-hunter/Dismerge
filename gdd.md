# Game Design Document #
Данный документ описывает правила и механики игры, в том виде, в каком это будет реализовано в готовом продукте. Текущая реализация, а также техническая часть, описаны в другом документе: *tech-spec.md*

## О продукте ##
Это казуальная мобильная игра с монетизацией на микротранзакциях. Весь прогресс сохраняется между сессиями и таймеры в игре учитывают реальное время. То есть, если игрок свернул/закрыл приложение, потом открыл через час, таймеры увеличаться на час.

## Core Game ## 
Игра происходит на прямоугольном поле 7*9 клеток, в каждой из которых может находится фишка.  Состояние поля сохраняется между игровыми сессиями.
Цель игры заключется в крафтинге определённых предметов (фишек) по механике merge-2, чтобы выполнять задания в мета-игре. Попутно игроку приходится оптимизировать состояние игрового поля, исследовать куда ведут цепочки фишек, создавать генераторы для них и тд.

### Цепочки ###
Все фишки, которые могут находиться на игровом поле merge-2, объединены в цепочки из 1 или более элементов (уровней). Каждая цепочка имеет собственное название, а каждый уровень в ней своё имя и картинку фишки. Для получения фишки следующего уровня игрок должен смерджить (совместить) две фишки предыдущего уровня этой цепочки. 
Некоторые цепочки имеют продолжение, т.е. после мерджа двух фишек наивысшего уровня получается фишка первого уровня из какой-то другой цепочки. Пока игрок не выполнит этот мердж, он не может знать, имеет ли цепочка продолжение.
Если цепочка не имеет продолжения, то фишки высшего уровня этой цепочки не могут быть смерджены.

### Выброс фишки (Drop) ###
Выброс фишки (дроп) это механика связанная с тем, что на поле могут находится фишки, являющиеся источниками новых фишек. Дроп может произойти только если на поле есть свободные клетки. 
Когда происходит дроп, новая фишка вылетает из источника, летит в направлении ближайшей свободной клетки поля и занимает эту ячейку.

### Генераторы ###
Без источника новых фишек игра не смогла бы продолжаться долго. Поэтому некоторые особые фишки, лежащие на поле, являются генераторами, создающими (дропающие) другие фишки при активации. Генерация бывает двух типов:
    * Ручная: для генерации фишек игрок должен тапнуть по генератору на поле;
    * Автоматическая: фишка генерируется лежащим на поле генератором через определённые интервалы по таймеру.
     Если приложение было свёрнуто/закрыто и потом было открыто, все таймеры обновятся так, словно бы они шли всё это время, однако все дропы, которые должны были прозойти в этот период неактивности, не произойдут. То есть, чтобы получать фишки  из генератора, игрок должен находится в игре.

После того, как генератор выбросит какое-то кол-во фишек, он уходит на перезарядку, в течении которой не может генерировать фишки этим способом активации.

Любой генератор может иметь как оба типа активации, так и лишь один из них. Настройки для каждого типа активации задаются отдельно и включают в себя:
    * Список фишек, которые могут быть получены из генератора и их вероятности;
    * Кол-во фишек, генерируемых до перезарядки (ёмкость генератора);
    * Длительность периода перезарядки.
Для автоматической генерации также задаётся:
    * Таймер между генерациями

Также существует механика уничтожаемых "одноразовых" генераторов, которые после заданного числа циклов ручной активации (автоматическая активация такой механики не имеет) или исчезают с поля, или превращаются в какую-то другую фишку. Для них задаются доп. параметры:
    * Кол-во циклов работы (1 значит, что уничтожение произойдёт вместо первой перезарядки, 2 - вместо второй и тд.);
    * ID фишки, в которую превращается после уничтожения.

Если дроп невозможен (на поле нет места), он откладывается до тех пор, пока не будет возможно его произвести. Если это автоматическая активация, то таймер ставится на паузу. Когда на поле освобождается место, автоматический дроп происходит и таймер снимается с паузы.

#### Конфигурация ####
Сведения о том, какие из фишек каких цепочек являются генераторами и их описанные выше параметры игра читает из конфигурационного файла *gen.csv*. Его особенность в том, что один и тот же генератор может занимать несколько строк таблицы, при этом каждая строка описывает генерацию одной фишки. Пример (для экономии места справа у таблицы отрезана секция про автоматическую генерацию):

|#стр.| id      | comment   | Dispose after| Dispose to | M:Capacity | M:Reload(sec) | M:Output   | M:Rate |
|-----|---------|-----------|--------------|------------|------------|---------------|------------|--------|--- -  -
|   1 | GEN_P-6 | начало    |           10 | TLS-1      | 20         | 10            | P_APP-1    |      5 |
|   2 |         |           |              |            |            |               | P_APP-2    |      1 |
|   3 |         |           |              |            |            |               | P_PIN-1    |      3 |
|   4 |         | конец     |              |            |            |               | P_PIN-2    |      1 |
|   5 | GEN_P-7 |           |              |            |            |               | P_PIN-1    |      5 |
:     :  ^^^    :           :              :            :            :               :            :        :
          тут начинается описание другого генератора

Здесь GEN_P-6 означает фишку 6 левела из цепочки GEN_P. Описание этого генератора начинается на первой строке, но поскольку он может генерировать разные типы фишек, это описание продолжается до 4 строки включительно. Эти дополнительные строки не содержат ID генератора, и других параметров, за исключением ID генерируемой фишки и её вероятности. На строке 5 указан новый id, что говорит о том, что здесь начинается описание другого генератора.

##### Поля конфигурационной таблицы #####
id              : id фишки-генератора в формате evo_id-lvl (id цепочки и цифра левела, разделённые дефисом)
Dispose after   : кол-во циклов ручной активации до уничтожения генератора
Dispose to      : id фмшки, в которую превращается после уничтожения. Если не задано, то просто исчезает
M:Capacity      : кол-во фишек, генерируемых до перезарядки (ёмкость генератора)
M:Reload(sec)   : 
M:Output
M:Rate
A:Capacity
A:Timer(sec)
A:Reload(sec)
A:Output
A:Rate

