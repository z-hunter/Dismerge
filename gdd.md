# Game Design Document #
Данный документ описывает правила и механики игры, в том виде, в каком это будет реализовано в готовом продукте. Текущая реализация, а также техническая часть, описаны в другом документе: *tech-spec.md*

## О продукте ##
Это казуальная F2P мобильная игра на Core механике merge-2 с монетизацией через микротранзакции. Весь прогресс сохраняется между сессиями и таймеры в игре учитывают реальное время. То есть, если игрок свернул/закрыл приложение, потом открыл через час, таймеры увеличаться на час.

## Core Game ## 
Игра происходит на прямоугольном поле 7*9 клеток, в каждой из которых может находится фишка.  Состояние поля сохраняется между игровыми сессиями.
Цель игры заключется в крафтинге определённых предметов (фишек) по механике merge-2, чтобы выполнять задания в мета-игре. Попутно игроку приходится оптимизировать состояние игрового поля, исследовать куда ведут цепочки фишек, создавать генераторы для них и тд.
В отличие от match-3, в merge-2 игровое поле это не левел, оно одно на всю игру. От количества свободного места и генераторов на нём зависит эффективность игры (чтобы скрафтить высокоуровневый предмет, нужно иметь достаточно свободного места для хранения промежуточных предметов). Менеджмент  правильной конфигурации и поддержание порядка на поле – важная часть челленджа в таких играх. 
Изначально поле почти целиком заполнено заблокироваными предметами (в коробках и паутине), которые игрок не может использовать, пока не смерджит предмет, лежащий на соседней ячейке поля. Игрок может разблокировать предмет на поле, заплатив Кристаллы.
Незаблокированные предметы можно свободно перемещать с одной ячейки поля на другую.
В начале игрок будет постепенно расчищать поле, открывая/создавая генераторы для самых важных цепочек предметов и попутно изучая основные цепочки.  Это обеспечивает плавное увеличение сложности игры. Поначалу игроку кажется, что всё что ему нужно, это находить на поле одинаковые предметы, как в маджонге. Глубина и стратегическая часть геймплея открывается гораздо позже. 


### Цепочки (Evo tables) ###
Все фишки, которые могут находиться на игровом поле, объединены в цепочки из 1 или более элементов (уровней). Максимально возможный левел цепочки -- 12. Каждая цепочка имеет собственное название, а каждый уровень в ней своё имя и картинку фишки. Для получения фишки следующего уровня игрок должен смерджить две фишки предыдущего уровня этой цепочки, то есть перетащить одну фишку на другую такую же. 
Некоторые цепочки имеют продолжение, т.е. после мерджа двух фишек наивысшего уровня получается фишка первого уровня из какой-то другой цепочки. Пока игрок не выполнит этот мердж, он не может знать, имеет ли цепочка продолжение.
Если цепочка не имеет продолжения, то фишки высшего уровня этой цепочки не могут быть смерджены.

### Выброс фишки (Drop) ###
Выброс фишки (дроп) это механика связанная с тем, что на поле могут находится фишки, являющиеся источниками новых фишек. Дроп может произойти только если на поле есть свободные клетки. 
Когда происходит дроп, новая фишка вылетает из источника, летит в направлении ближайшей свободной клетки поля и занимает эту ячейку. Этот полёт фишки не должен блокировать действия пользователя, целевая клетка автоматически считается занятой и далее игрок может продолжать нажимать на генератор чтобы из него вылетали новые фишки. Таким образом:
1) размещение новой фишки на поле учитывается в системе уже перед началом полёта фишки, а сам полёт это только визуализация;
2) возможна ситуация, когда летят одновременно несколько фишек;
3) возможна ситуция, когда летят одна или несколько фишек, а пользователь выполняет действия на поле -- тап по генератору, перетаскивание фишки и тд.

Дроп бывает *обычный*, когда фишка может вылететь на любую свободную клетку и *ближний*, когда фишка может вылететь лишь на клетку, непосредственно прилегающую к клетке с источником дропа (одну из 8). Выбор типа дропа задаётся его источником.

### Генераторы ###
Без источника новых фишек игра не смогла бы продолжаться долго. Поэтому, некоторые особые фишки, лежащие на поле, являются генераторами, создающими (дропающие) другие фишки при активации. Генерация бывает двух типов:
    * Ручная: для генерации фишек игрок должен тапнуть по генератору на поле;
    * Автоматическая: фишка генерируется лежащим на поле генератором через определённые интервалы по таймеру.
     Если приложение было свёрнуто/закрыто и потом было открыто, все таймеры обновятся так, словно бы они шли всё это время, однако все дропы, которые должны были прозойти в этот период неактивности, не произойдут. То есть, чтобы получать фишки  из генератора, игрок должен находится в игре.

После того, как генератор выбросит какое-то кол-во фишек, он уходит на перезарядку, в течении которой не может генерировать фишки *этим* способом активации.

Любой генератор может иметь как оба типа активации (два генератора в одном), так и лишь один из них (ручной или автоматический генератор). Настройки для каждого типа активации задаются отдельно и включают в себя:
    * Список фишек, которые могут быть получены из генератора и их вероятности;
    * Кол-во фишек, генерируемых до перезарядки (Capacity генератора);
    * Длительность периода перезарядки.
Для автоматической генерации также задаётся:
    * Таймер между генерациями

##### Одноразовые генераторы #####
Существует механика уничтожаемых "одноразовых" генераторов, которые после заданного числа циклов ручной активации (автоматическая активация такой механики не имеет) или исчезают с поля, или превращаются в какую-то другую фишку
Цикл активации это выброс полного M:Capacity из генератора (см. Конфигурация генераторов). После Dispose_after циклов активации вместо перезарядки такой генератор заеняется на фишку, заданную параметром Dispose_to. Если этот параметр не задан, он просто уничтожается.

##### Автоматические генераторы #####
В основном они похожи на ручные, но со следующими особенностями:
- У них нет механики "одноразовости";
- Активируются автоматически;
- Используют ближний дроп (см. раздел 'Выброс фишки');
- В отличии от ручных генераторов, появдяющихся на поле готовыми к генерации, автоматические появляются на поле в состоянии перезарядки, то есть после появления они сначала перезаряжаются, а потом генерируют фишки с заданным интервалом ( A:Timer(sec) ) до следующей перезарядки;
- Во время перезарядки автоматического генератора на его фишке появляется индикатор прогресса, аналогичный индикатору перезарядки ручного генератора, но зелёного цвета и в левом верхнем углу;
- Поскольку в одной фишке могут быть одновременно и ручной и автоматический генераторы, которые совершенно независимы друг от друга, то возможны ситуации, когда на ней будут отображаться сразу оба индикатора. 


##### Дроп из генератора #####
Ручная активация использует обычный дроп, а автоматическая использует ближний дроп, то есть могут выбрасывать фишки только на ячейки, примыкающие к генератору.
Если дроп невозможен (нет подходящих свободных ячеек), в случае ручной активации он просто не производится. В случае автоматической активации, он откладывается и таймер ставится на паузу. Когда на поле освобождается место вокруг генератора, отложенный ближний дроп происходит и таймер снимается с паузы.

##### Использование в игре #####
Как и всякий любой предмет на merge-2 поле, генератор принадлежит к какой-то цепочке. При этом, не обязательно, что все уровни этой цепочки являются генераторами. Обычно, начальные уровни цепочки генераторов это лишь заготовки. Игрок мерджит их до таких уровней, на которых они становятся способны что-то сгенерировать. Но генераторы первых левелов при этом слабы, и надо мерджить их до более высоких уровней, чтобы увеличить количество и/иди ассортимент получаемых с них фишек.
Используя разные настройки генератора, гейм-дизайнеры могут создать очень разные по поведению предметы. Например, представим, что объект 4 уровня из цепочки является одноразовым ручным генератором, который выбрасывает один предмет – древесину 1 уровня, и после этого исчезает. Таким образом, из этой цепочки появляется ответвление, порождающую другую цепочку. Но игрок может вместо этого смерджить два объекта 4 уровня и получить объект 5 уровня, который также является одноразовым генератором, но выкидывает уже два куска древесины. Кроме того, он одновременно является ещё и многоразовым автоматическим генератором, поэтому периодически выбрасывает из себя листья, являющиеся предметом 1 уровня из ещё одной цепочки. Игрок может или пустить его на древесину, и потерять генератор, или же может оставить на поле, чтобы получить постоянный источник листьев, которые могут понадобится для создания каких-то других предметов.


#### Вероятности дропа фишек из генератора ####
Для каждой фишки, которая может выпадать из генератора задана вероятность её появления при дропе. Это просто целое число, задающее отношение вероятности выпадения этой фишки к остальным. Например, если фишка A имеет вероятность 1 а фишка B вероятность 2, то фишка B выпадает в 2 раза чаще чем A.
При импорте конфига вероятности всех фишек для каждого типа активации суммируются и хранятся как отдельное поле S (этих полей два - для ручной и автоматической активации). Когда генератор активируется, генерируется случайное целое число от 1 до S (включительно). После этого, полученное число по очереди сравнивается со всеми вероятностями выпадения фишек из списка, чтобы определить попадание в их интервал на отрезке 1--S, пропорциональный вероятностям выпадени фишек. Например, в примере выше S=3. Если выпадет рандомное число 2, сначала оно сравнивается с интервалом A (1--1), устанавливается, что это число не находится в интервале, потому проверяется попадание в следующий интервал B (2--3), что подтверждается, поэтому выпадает фишка B. 

 
#### Конфигурация генераторов ####
Сведения о том, какие из фишек каких цепочек являются генераторами и их описанные выше параметры игра читает из конфигурационного файла *gen.csv*. Его особенность в том, что один и тот же генератор может занимать несколько строк таблицы, при этом каждая строка описывает генерацию одной фишки. Пример (для экономии места справа у таблицы отрезана секция про автоматическую генерацию):

#стр.| id      | comment | Dispose_after| Dispose_to | M:Capacity | M:Reload(sec) | M:Output   | M:Rate |
-----|---------|---------|--------------|------------|------------|---------------|------------|--------|-- -  -
   3 | GEN_P-6 | начало  |           10 | TLS-1      | 20         | 10            | P_APP-1    |      5 |
   4 |         |         |              |            |            |               | P_APP-2    |      1 |
   5 |         |         |              |            |            |               | P_PIN-1    |      3 |
   6 |         | конец   |              |            |            |               | P_PIN-2    |      1 |
   7 | GEN_P-7 |         |              |            |            |               | P_PIN-1    |      5 |
     :  ^^^    :         :              :            :            :               :            :        :
         описание другого генератора

Здесь GEN_P-6 означает фишку 6 левела из цепочки GEN_P. Описание этого генератора начинается на строке 3, но поскольку он может генерировать разные типы фишек и каждая фишка описана в отдельной строке, это описание продолжается до 6 строки включительно. Эти дополнительные строки не содержат id генератора, и других параметров, за исключением генерируемой фишки и её вероятности выпадения. В строке 7 указан новый id генератора, что говорит о том, что здесь начинается его описание а описание предыдущего закончено строкой выше.

##### Поля конфигурационной таблицы #####
id              : id фишки-генератора в формате evo_id-lvl (id цепочки и цифра левела, разделённые дефисом)
Dispose_after   : кол-во циклов ручной активации до уничтожения генератора
Dispose_to      : id фишки, в которую превращается после уничтожения. Если не задано, то просто исчезает
M:Capacity      : ёмкость генератора для ручной активации
M:Reload(sec)   : длительность периода перезарядки (в сек.) для ручной активации
M:Output        : список id генерируемых фишек для ручной активации (одна строка -- один id)
M:Rate          : вероятности генерируемых фишек для ручной активации
A:Capacity      : ёмкость генератора для ручной активации
A:Timer(sec)    : промежуток времени между автоматическими активациями
A:Reload(sec)   : длительность периода перезарядки для автоматической активации
A:Output        : список id генерируемых фишек для автоматической активации (одна строка -- один id)
A:Rate          : вероятности генерируемых фишек для автоматической активации


### Удаление предмета с поля ###
Игрок может удалить любой предмет с поля, кроме заблокированных в коробках и паутине. При этом, он теряет предмет. Данная возможность необходима, потому что если на игровом поле не останется свободного места, играть дальше может оказаться невозможно.


### Инвентарь ###
Это специальная область для хранения тех предметов, которые игроку в данный момент на поле не нужны, но удалять их он не хочет. Предметы, помещённые в Инвентарь, замораживаются и не участвуют в игре (таймеры генераторов становятся на паузу).
Изначально в инвентаре открыт лишь один свободный слот. Игрок может открывать дополнительные слоты за Кристаллы, причём каждый следующий слот стоит дороже.
В любой момент времени игрок может перенести в Инвентарь любой незаблокированный предмет на поле, а также перенести предмет обратно из Инвентаря на любую свободную ячейку поля.

### Пузырь-оффер ###
Когда игрок совершает мердж высокоуровневых предметов (5 уровень и выше), иногда на поле может кратковременно появиться пузырь, содержащий копию созданной фишки. Если игрок заплатит фиксированную сумму в кристаллах, эта фишка остаётся на поле. В противном случае, она “лопается” вместе с пузырём. Это важный элемент монетизации merge-2, поскольку для создания высокоуровневого предмета игроку требуется много времени, и в тот момент, когда он наконец закончил крафтить предмет, он испытывает повышенный соблазн получить второй такой предмет мгновенно, не затрачивая усилий.

### Экономическая модель Core ###
При L = целевой уровень собираемого предмета, Q = кол-во предметов первого уровня, требуемое для этого, а Mq = кол-во мерджей, которое для этого потребуется:

        Q = 2^(L-1); 	Mq = Q-1;





## Монетизация ##
Магазин: покупка контейнеров (сундучков с предметами) за кристаллы и деньги;
“Пузырь-оффер” за кристаллы;
Очистка пассивных предметов на поле за кристаллы;
Плата за расширение Инвентаря;
Ускорение генераторов за кристаллы.


## --- на будущее
Ускорение перезарядки
Игрок может моментально перезарядить генератор с ручной активацией, просто заплатив внутриигровой валютой (кристаллами). Цена расчитывается динамически, в зависимости от оставшегося времени перезарядки.
Автоматический генератор ускорить нельзя. 

Защита от фарма (“истощение” генератора)
Если игрок многократно использует генератор сразу после того, как тот перезарядится, генератор начинает временно “деградировать”, то есть его время перезарядки постепенно увеличиваться, а предметов после перезарядки выпадает всё меньше. После заданного периода неиспользования (пара часов), он полностью восстанавливается.
Таким образом мы нормализуем игровую сессию и ограничиваем возможность игроку фармить предметы. Если он хочет больше предметов, ему придётся не зависать в игре часами, а воспользоваться Магазином.
